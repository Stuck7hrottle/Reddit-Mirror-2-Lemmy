services:
  reddit-mirror:
    build: .
    container_name: reddit_mirror_worker
    command: python3 background_worker.py
    restart: always
    volumes:
      - ./data:/opt/Reddit-Mirror-2-Lemmy/data
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "python3", "-c", "import os; exit(0 if os.path.exists('data/jobs.db') else 1)"]
      interval: 60s
      timeout: 5s
      retries: 3
        # Uncomment below if you want to connect to your Lemmy-Ansible Docker network
    #networks:
    #  - your_lemmy_network

  reddit-refresh:
    build: .
    container_name: reddit_mirror_refresh
    command: >
      bash -c "
        while true; do
          echo 'üîÅ Running refresh cycle...';
          python3 auto_mirror.py --refresh;
          echo '‚è≥ Sleeping for ${REFRESH_INTERVAL:-3600} seconds...';
          sleep ${REFRESH_INTERVAL:-3600};
        done
      "
    restart: always
    volumes:
      - ./data:/opt/Reddit-Mirror-2-Lemmy/data
      - ./.env:/opt/Reddit-Mirror-2-Lemmy/.env:ro
    env_file:
      - .env
    depends_on:
      - reddit-mirror
    # Uncomment below if you want to connect to your Lemmy-Ansible Docker network
    #networks:
    #  - your_lemmy_network

  mirror-dashboard:
    build:
      context: ./dashboard
    container_name: mirror-dashboard
    # Bind only to localhost if you plan to reverse-proxy through Cloudflare or Nginx
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      - DATA_DIR=/opt/Reddit-Mirror-2-Lemmy/data
    volumes:
      - ./data:/opt/Reddit-Mirror-2-Lemmy/data
      - ./dashboard/static:/app/static
    # Use --reload only in development; remove in production for stability
    command: uvicorn main:app --host 0.0.0.0 --port 8080 --reload
    restart: unless-stopped
        # Uncomment below if you want to connect to your Lemmy-Ansible Docker network
    #networks:
    #  - your_lemmy_network

  lemmy_comment_sync:
    build: .
    container_name: lemmy_comment_sync
    restart: unless-stopped
    environment:
      - LEMMY_URL=${LEMMY_URL}
      - LEMMY_USER=${LEMMY_USER}
      - LEMMY_PASS=${LEMMY_PASS}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}
      - REDDIT_USERNAME=${REDDIT_USERNAME}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD}
      - REDDIT_USER_AGENT=${REDDIT_USER_AGENT}
      - DATA_DIR=/opt/Reddit-Mirror-2-Lemmy/data
      - LEMMY_COMMENT_SYNC_INTERVAL=${LEMMY_COMMENT_SYNC_INTERVAL}
      - LEMMY_COMMENT_FETCH_LIMIT=${LEMMY_COMMENT_FETCH_LIMIT}
    volumes:
      - ./data:/opt/Reddit-Mirror-2-Lemmy/data
    depends_on:
      - reddit-mirror

  reddit_comment_sync:
    build: .
    container_name: reddit_comment_sync
    restart: unless-stopped
    environment:
      - LEMMY_URL=${LEMMY_URL}
      - LEMMY_USER=${LEMMY_USER}
      - LEMMY_PASS=${LEMMY_PASS}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET}
      - REDDIT_USERNAME=${REDDIT_USERNAME}
      - REDDIT_PASSWORD=${REDDIT_PASSWORD}
      - REDDIT_USER_AGENT=${REDDIT_USER_AGENT}
      - DATA_DIR=/opt/Reddit-Mirror-2-Lemmy/data
      - REDDIT_COMMENT_SYNC_INTERVAL=${REDDIT_COMMENT_SYNC_INTERVAL}
    volumes:
      - ./data:/opt/Reddit-Mirror-2-Lemmy/data
    depends_on:
      - reddit-mirror

#Optional internal network connection to Lemmy
#networks:
#  lemmy_net:
#    external: true
#    name: your_lemmy_network