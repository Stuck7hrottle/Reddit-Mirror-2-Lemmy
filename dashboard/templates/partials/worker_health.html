<div id="worker-health" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  {% for c in containers %}
  <div class="
    bg-gray-700 p-4 rounded-lg shadow hover:bg-gray-600 transition
    {% if 'running' in c.status %}
      pulse-green
    {% elif 'restarting' in c.status %}
      pulse-yellow
    {% elif 'exited' in c.status %}
      pulse-red
    {% endif %}
  ">
    <p class="text-lg font-semibold mb-2 flex items-center justify-between">
      <span>
        {{ c.name }}
        {% if c.name == 'lemmy_comment_sync' and c.sync_state %}
          <span class="ml-1 text-sm {% if c.sync_state == 'active' %}text-green-400{% else %}text-gray-400{% endif %}">
            ({{ c.sync_state }})
          </span>
        {% endif %}
      </span>

      {% if c.name == 'lemmy_comment_sync' %}
        <button onclick="toggleCommentSync()" 
          class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded ml-2">
          Toggle Sync
        </button>
      {% endif %}
    </p>

    <div class="flex flex-wrap gap-2 mb-3">
      {% if 'running' in c.status %}
        <!-- Running containers: restart / stop -->
        <button onclick="confirmAction('{{ c.name }}', 'restart')"
          class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded">
          Restart
        </button>
        <button onclick="confirmAction('{{ c.name }}', 'stop')"
          class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded">
          Stop
        </button>

      {% elif 'exited' in c.status or 'not found' in c.status or 'error' in c.status %}
        <!-- Stopped / missing: start / build / build no-cache -->
        <button onclick="confirmAction('{{ c.name }}', 'start')"
          class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded">
          Start
        </button>
        <button onclick="confirmBuild('{{ c.name }}', false)"
          class="text-xs bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded">
          Build
        </button>
        <button onclick="confirmBuild('{{ c.name }}', true)"
          class="text-xs bg-orange-600 hover:bg-orange-500 text-white px-3 py-1 rounded">
          Build (no cache)
        </button>
      {% endif %}
    </div>

    {% if 'running' in c.status %}
      <p class="status-text running font-semibold text-green-400">ğŸŸ¢ {{ c.status }}</p>
    {% elif 'restarting' in c.status %}
      <p class="status-text restarting font-semibold text-yellow-400">ğŸŸ¡ {{ c.status }}</p>
    {% elif 'exited' in c.status %}
      <p class="status-text exited font-semibold text-red-400">ğŸ”´ {{ c.status }}</p>
    {% else %}
      <p class="status-text font-semibold text-gray-400">âšª {{ c.status }}</p>
    {% endif %}

    <p class="text-sm text-gray-300 mt-2">
      CPU {{ c.cpu_percent }}% Â· MEM {{ c.mem_mb }} MB ({{ c.mem_percent }}%)
    </p>
    <p class="text-xs text-gray-400 truncate">â±ï¸ Started {{ c.uptime }}</p>
  </div>
  {% endfor %}
</div>

<script>
function confirmAction(name, action) {
  openConfirmModal(
    `Are you sure you want to ${action.toUpperCase()} â€œ${name}â€?`,
    () => {
      showLoading(`${action.toUpperCase()} in progressâ€¦`, action);
      fetch(`/dashboard/container/${name}/${action}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          hideLoading();
          if (data.success) {
            showToast(`âœ… ${data.success}`);
          } else {
            showToast(`âš ï¸ ${data.error || 'Unexpected error'}`, true);
          }
          // Refresh the worker grid
          htmx.ajax('GET', '/dashboard/health', '#worker-health');
        })
        .catch(err => {
          hideLoading();
          showToast(`âŒ Network error: ${err}`, true);
        });
    }
  );
}

function confirmBuild(name, noCache) {
  const label = noCache ? 'BUILD (no cache)' : 'BUILD';
  openConfirmModal(
    `Are you sure you want to ${label} â€œ${name}â€? This may take a few minutes.`,
    () => {
      showLoading(`${label} in progressâ€¦`, 'build');
      const url = `/dashboard/container/${name}/build${noCache ? '?no_cache=true' : ''}`;
      fetch(url, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          hideLoading();
          if (data.success) {
            showToast(data.success);
          } else {
            showToast(data.error || 'Build failed', true);
          }
          htmx.ajax('GET', '/dashboard/health', '#worker-health');
        })
        .catch(err => {
          hideLoading();
          showToast(`âŒ Network error: ${err}`, true);
        });
    }
  );
}

function toggleCommentSync() {
  openConfirmModal(
    `Toggle Lemmyâ†’Reddit comment sync?`,
    () => {
      showLoading("Toggling comment sync...", "build");
      fetch(`/dashboard/container/toggle-comment-sync`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          hideLoading();
          if (data.success) {
            showToast(`âœ… ${data.success}`);
            htmx.ajax('GET', '/dashboard/health', '#worker-health');
          } else {
            showToast(`âš ï¸ ${data.error || 'Unexpected error'}`, true);
          }
        })
        .catch(err => {
          hideLoading();
          showToast(`âŒ Network error: ${err}`, true);
        });
    }
  );
}
</script>
